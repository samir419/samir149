<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        button{
            width: 100px;
            height: 100px;
        }
        .move{
            background-color: lightblue;
            width: 100px;
            height: 100px;
        }
        .ui{
            width: 100%;
            max-width: 920;
             height: 100%; background-color: rgb(0,0,255,0.5);
            position: absolute; z-index: 100;
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        .ui-fixed{
            width: 100%;
            max-width: 920;
             height: 100%;
            position: absolute; z-index: 90;
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
    </style>
</head>
<body>
    <div style="display: flex;align-items: center;justify-content: center;width: 100%;flex-direction: column;">
        <div class="ui" id="select-mode">
           <div>
                <h2>select mode</h2>
                <button onclick="mode='single';display_ui('select-player');select.play()">single player</button>
                <button onclick="mode='multi';display_ui('select-player');select.play()">multiplayer</button>
                <button onclick="mode='watch';display_ui('select-player');select.play()">watch</button>
           </div>
        </div>
        <div class="ui" id="select-player">
            <h2 id="select-player-msg">player 1 select</h2>
        </div>
        <div class="ui" id="win-screen">
            <div>
                <h2 id="win-screen-msg"></h2>
                <button onclick="game = new Game();game.start()">restart</button>
            </div>
        </div>
         <div class="ui-fixed" id="debug">
            <div>
                <p id="process"></p>
                <p id="p1data"></p>
                <p id="p2data"></p>
            </div>
        </div>
         <canvas id="game-canvas" style="width: 100%;max-width: 920;border: solid;" onclick="if(game.state=='wait')game.start()"></canvas>
    </div>
   
    <div style="display: flex;flex-direction: row;width: 100%;justify-content: space-between;">
        <div style="display: grid;grid-template-columns: auto auto;">
            <button onclick="game.handle_input('j')">special 1</button>
            <button onclick="game.handle_input('k')">special 2</button>
            <button onclick="game.handle_input('d')">parry</button>
            <button onclick="game.handle_input('l')">ultimate</button>
        </div>
        <div style="display: grid;grid-template-columns: auto auto;">
            <button onclick="game.handle_input('q')">dash up</button>
            <div class="move" id="up">move up</div>
            <button onclick="game.handle_input('e')">dash down</button>
            <div class="move" id="down">move down</div>
        </div>
    </div>
   
    <button onclick="game.state='running'">restart</button>
    <button onclick="music.pause()">pause</button>
    <script src="player.js"></script>
    <script src="special moves.js"></script>
    <script src="chars.js"></script>
    <script src="ui.js"></script>
    <script>
        let mode
        let game
        let main_char
        let main_char2 
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 720
        canvas.height = 480
        score_point = new Audio()
        score_point.src = 'game-start-317318.mp3'
        ball_bounce = new Audio()
        ball_bounce.src = 'soccer-kick-6235.mp3'
        music = new Audio()
        music.loop=true
        music.src = 'game-music-loop-6-144641.mp3'
        class Game{
            constructor(){
                this.players =[
                    new Player(1,main_char),
                    new Player(2,main_char2)
                ]
                this.ball = new Ball()
                this.state = 'wait'
                this.input_buffer=0
                this.input_buffer2=0
                this.freezetimer=0
                this.processes = []

                this.background = new Image()
                this.background.src = 'arena.png'
                this.meterbar = new Image()
                this.meterbar.src = 'meter bar.png'
                
            }
            start(){
                display_ui('none');
                this.reset()
                this.ball.dx=5
                this.ball.dy=5
                this.state='running'
                music.play()
                this.update()
            }
            reset(){
                this.players[0].x = 15
                this.players[0].y = 240
                this.players[0].meter = 0
                this.players[0].health = 100
                this.players[1].x = 655
                this.players[1].y = 240
                this.players[1].meter = 0
                this.players[1].health = 100
                this.ball.x = canvas.width/2
                this.ball.y = canvas.height/2
            }
            handle_freeze_frame(){
                this.freezetimer--
                if(this.freezetimer==0){
                    if(this.players[0].health<=0||this.players[1].health<=0){
                     this.reset()
                    }
                    this.state='running'
                }
            }
            get_collision(a,b){
                return (
                    a.x < b.x + b.width &&
                    a.x + a.width > b.x &&
                    a.y < b.y + b.height &&
                    a.y + a.height > b.y
                )
            }
            handle_input(key){
                if(this.input_buffer>0){
                    return
                }
                if(key=='p'){
                    if(this.state=='pause'){
                        display_ui('none')
                        this.state = 'running'
                    }else{
                        this.state = 'pause'
                        display_ui('win-screen')
                    }
                }
                if(key=='f'){
                    this.state = 'freezeframe'
                    this.freezetimer=20
                }
                if(key=='d'){
                    this.players[0].direction=0
                    this.players[0].parry()
                }
                if(key=='q'){
                    this.players[0].dash(-1)
                }
                if(key=='e'){
                    this.players[0].dash(1)
                }
                if(key=='j'){
                    let move = generate(this.players[0].special_moves[0])  
                    move.onstart(this.players[0],this.players[1],this)
                }
                if(key=='k'){
                    let move = generate(this.players[0].special_moves[1]) 
                    move.onstart(this.players[0],this.players[1],this)
                }
                 if(key=='l'){
                    let move = generate(this.players[0].ultimatemove)
                    move.onstart(this.players[0],this.players[1],this)
                }
                this.input_buffer=10
            }
            render(){
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle='black'
                ctx.drawImage(this.background,0,0, canvas.width, canvas.height);
                
                this.processes.forEach(p=>{
                    ctx.fillStyle=p.color
                    if(p.image){
                        ctx.drawImage(p.image,p.x,p.y)
                    }else{
                        ctx.fillRect(p.x,p.y,p.w,p.h)
                    }
                   
                    
                })
                ctx.fillStyle='white'
                ctx.fillRect(this.ball.x,this.ball.y,this.ball.width,this.ball.height)
                this.players.forEach(function(player,index){
                    if(player.isultimate==true){
                        ctx.fillStyle='orange'
                        ctx.fillRect(player.x-25,player.y-25,player.width+50,player.height+50)
                    }
                    ctx.strokeRect(player.x,player.y,player.width,player.height)
                    let img = player.get_image();

                    // Save context before applying transforms
                    ctx.save();

                    // Move origin to image center so flipping is around the character,
                    // not around the canvas corner.
                    let drawX = player.x - (img.w / 4);
                    let drawY = player.y - (img.h / 4);
                    let centerX = drawX + img.w / 2;
                    let centerY = drawY + img.h / 2;
                    ctx.translate(centerX, centerY);
                    // Apply flipping
                    if(player.num==2){
                        ctx.scale(-1, 1);
                    }else{
                         ctx.scale(1, 1);
                    }
                    // Draw image offset back because we've moved origin to center
                    ctx.drawImage(img.image, -img.w / 2, -img.h / 2);
                    // Restore normal drawing state
                    ctx.restore();

                })
                ctx.fillStyle='yellow'
                
                ctx.fillRect(0,460,this.players[0].meter,20)
                ctx.fillRect(canvas.width-90,460,this.players[1].meter,20)
                ctx.drawImage(this.meterbar,0,460)
                ctx.drawImage(this.meterbar,canvas.width-90,460)
                ctx.fillStyle='red'
                ctx.fillRect(0,0,this.players[0].health,20)
                ctx.fillRect(720-100,0,this.players[1].health,20)
            }
            update(){
                //document.getElementById('process').textContent=JSON.stringify(this.processes)
                //document.getElementById('p1data').textContent=JSON.stringify(this.players[0])
                //document.getElementById('p2data').textContent=JSON.stringify(this.players[1])
                if(this.state=='running'){
                    this.players[0].update()
                    
                    this.players[1].update()
                    this.ball.update()
                    if(mode=='single'){
                        this.players[1].cpu(this.players[1],this.players[0],this)
                    }
                    if(mode=='watch'){
                        this.players[1].cpu(this.players[1],this.players[0],this)
                        this.players[0].cpu(this.players[0],this.players[1],this)
                    }
                
                    this.processes.forEach((process,index)=>{
                        process.update(this)
                        if(process.state=='dead'){
                            this.processes.pop(index)
                        }
                    })
                        
                    this.players.forEach((player,index)=>{
                        if(this.get_collision(this.ball,player)){
                            if(this.ball.state=='normal'){
                                ball_bounce.play()
                                this.ball.dx*=-1
                                if(this.ball.lasthit!=player){
                                     this.ball.lasthit=player
                                    player.meter+=10
                                }
                               
                            
                                if(this.get_collision(this.ball,player.upper_hitbox)){
                                    if(this.ball.dy>0){
                                        this.ball.dy*=-1
                                        this.ball.dy-=player.dy*0.2
                                    }
                                    if(this.ball.dy==0){
                                        this.ball.dy = -5
                                    }
                                }
                                if(this.get_collision(this.ball,player.lower_hitbox)){
                                    if(this.ball.dy<0){
                                        this.ball.dy*=-1
                                        this.ball.dy+=player.dy*0.2
                                    }
                                     if(this.ball.dy==0){
                                        this.ball.dy = 5
                                    }
                                }
                            }
                            
                            if(player.state=='parry'){
                                if(this.ball.state!='normal'){
                                    this.ball.dx*=-1
                                }
                                player.state='idle'
                                this.ball.dx*=2
                                player.meter+=10
                                let aud= new Audio()
                                aud.src = 'parry.wav'
                                aud.play()
                                this.state = 'freezeframe'
                                this.freezetimer=20

                            }
                        }
                       
                    })
                   
                   
                    if(this.ball.x<=0||this.ball.x>=canvas.width){
                        this.ball.lasthit=null
                        if(this.ball.x<=0){
                            this.players[0].meter+=5
                            this.players[0].health-=10
                            score_point.play()
                        }
                        if(this.ball.x>=canvas.width){
                            this.players[1].meter+=5
                            this.players[1].health-=10
                            score_point.play()
                        }
                        if(this.ball.state!='normal'){
                             if(this.ball.x<=0){
                                this.players[0].health-=20
                            }
                            if(this.ball.x>=canvas.width){
                                this.players[1].health-=20
                            }
                            this.ball.state='normal'
                            this.ball.width=25
                            this.ball.height=25
                        }
                        this.ball.x = canvas.width/2
                        this.ball.y = canvas.height/2
                        this.ball.dx*=-1
                        if(this.ball.dx<0){
                            this.ball.dx=-5
                        }else{
                            this.ball.dx=5
                        }
                        if(this.ball.dy>5){
                            this.ball.dy=5
                        }
                        if(this.ball.dy<-5){
                            this.ball.dy=-5
                        }
                        this.state = 'freezeframe'
                        this.freezetimer=30
                    }
                    if(this.ball.y<=0||this.ball.y>=canvas.height){
                        ball_bounce.play()
                        this.ball.dy*=-1
                    }
                    this.render()
                    if(this.players[0].health<=0||this.players[1].health<=0){
                        this.state='wait'
                        if(this.players[0].health>0){
                            document.getElementById('win-screen-msg').textContent=`${this.players[0].char.name} wins`
                        }
                         if(this.players[1].health>0){
                            document.getElementById('win-screen-msg').textContent=`${this.players[1].char.name} wins`
                        }
                        this.reset()
                        if(mode=='single'){
                            main_char2=characters[Math.floor(Math.random()*characters.length)];
                        }
                        display_ui('win-screen')
                    }
                }
                if(this.state=='freezeframe'){
                    this.handle_freeze_frame()
                }
                if(this.state=='wait'){
                   
                }
                if(this.input_buffer>0){
                    this.input_buffer--
                }
                 if(this.input_buffer2>0){
                    this.input_buffer2--
                }
                requestAnimationFrame(this.update.bind(this))
            }
        }
        
        document.addEventListener("keydown", event => {
            if(game.players[0].state=='idle'){
                if (event.key === "w"){game.players[0].direction=-1;game.players[0].dy=-5;}
                if (event.key === "s"){ game.players[0].direction=1;game.players[0].dy=5;}
            }
            game.handle_input(event.key)
        });
        document.addEventListener("keyup", event => {
            if(game.players[0].state=='idle'){
                if (event.key === "w")game.players[0].dy=0;
                if (event.key === "s")game.players[0].dy=0;
            }
        });

        canvas.addEventListener("touchstart", function(e) {
            e.preventDefault();
            const touch = e.touches[0];
            game.players[0].y = touch.clientY - game.players[0].height;
        })
        canvas.addEventListener("touchmove", function(e) {
            e.preventDefault();
            const touch = e.touches[0];
            game.players[0].y = touch.clientY - game.players[0].height;
        })
        document.getElementById('up').addEventListener("touchstart", function(e) {
            e.preventDefault();
            game.players[0].dy=-5
        })
         document.getElementById('up').addEventListener("touchend", function(e) {
            e.preventDefault();
            game.players[0].dy=0
        })
         document.getElementById('down').addEventListener("touchstart", function(e) {
            e.preventDefault();
            game.players[0].dy=5
        })
         document.getElementById('down').addEventListener("touchend", function(e) {
            e.preventDefault();
            game.players[0].dy=0
        })
        
    </script>
    <script src="player2controls.js"></script>
</body>
</html>